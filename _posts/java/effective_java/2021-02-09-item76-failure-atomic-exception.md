---
title: "[Effective Java] Item 76. 가능한 한 실패 원자적으로 만들라"
excerpt: "호출된 메서드가 실패하더라도 해당 객체는 메서드 호출 전 상태를 유지해야 한다."
categories:
  - Java
tags:
  - Java
  - Effective Java
date: 2021-02-09
last_modified_at: 2021-02-09
---

## 1. 실패 원자성(Failure-Atomic)

호출된 메서드가 실패하더라도 해당 객체는 메서드 호출 전 상태를 유지해야 한다. 이러한 특성을 실패 원자적이라고 한다.

메서드를 실패 원자적으로 만드는 방법은 다음과 같다.

* 불변 객체는 실패해도 새로운 객체가 만들어지지 않는 태생적으로 실패 원자적이다.
* 가변 객체의 메서드는 매개변수의 유효성을 검사한다.
* 실패할 가능성이 있는 모든 코드를, 객체의 상태를 바꾸는 코드보다 앞에 배치한다.
* 객체의 임시 복사본에서 작업을 수행한 다음, 작업이 성공적으로 완료되면 원래 객체와 교체한다.
  * SNAPSHOT or Transaction.
  * 컬렉션 정렬 메서드는 원소 접근이 빠른 배열에 데이터를 옮겨 정렬을 수행한다.
    * 정렬에 실패하더라도 입력 리스트는 변함없다.
* 작업 도중 발생하는 실패를 가로채는 복구 코드를 작성해 작업 전 상태로 되돌린다.
  * 디스크 기반의 내구성을 보장하는 자료구조에 쓰인다.

<br>

## 2. 실패 원자성을 달성할 수 없는 경우

메서드 명세에 기술한 예외라면 설혹 예외가 발생하더라도 객체의 상태는 메서드 호출 전과 똑같이 유지되어야 하는 것이 기본 규칙이다.

* 두 스레드가 동기화 없이 같은 객체를 수정한다면 객체의 일관성이 깨질 수 있다.
  * 따라서 ConcurrentModificationException을 잡았어도, 객체를 쓸 수 있는 상태라고 가정해서는 안 된다.
* Error는 복구할 수 없으므로 AssertionError에 대해서는 실패 원자적으로 만들려는 시도조차 할 필요도 없다.
* 실패 원자적으로 만들 수 있더라도, 원자성을 달성하는 비용이나 복잡도가 큰 경우 고민해야 한다.

<br>

---

## Reference

* Effective Java 3/E(Joshua Bloch 저)
